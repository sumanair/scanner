// Get Base64 data from the URL query parameter
const urlParams = new URLSearchParams(window.location.search);
const base64Data = urlParams.get('data');

const decodedDataElement = document.getElementById('decodedData');
const metadataSection = document.getElementById('metadataContent');
const jsonToggle = document.getElementById('jsonToggle');
const jsonContent = document.getElementById('jsonContent');

if (base64Data) {
    try {
        // Decode the Base64 data and parse JSON
        const decodedString = decodeURIComponent(atob(base64Data));
        const decodedJson = JSON.parse(decodedString);

        // Separate main data and metadata
        const mainData = decodedJson.data || decodedJson; // Assuming 'data' is the main key
        const metadata = decodedJson.metadata_from_qrmaker || {};

        // Render the main data as a table
        decodedDataElement.innerHTML = renderJsonAsTable(mainData);

        // Render the metadata as a nested table
        metadataSection.innerHTML = renderJsonAsTable(metadata);

        // Show the full JSON in collapsible section
        jsonContent.innerText = JSON.stringify(decodedJson, null, 2);

        // Toggle display of raw JSON content
        jsonToggle.onclick = () => {
            jsonContent.style.display = jsonContent.style.display === "none" ? "block" : "none";
            jsonToggle.innerText = jsonContent.style.display === "none" ? "Show Raw JSON" : "Hide Raw JSON";
        };
    } catch (error) {
        console.error("Error decoding Base64 or parsing JSON:", error);
        decodedDataElement.innerText = 'Invalid data format. Expected Base64-encoded JSON.';
    }
} else {
    decodedDataElement.innerText = 'No data found. Please scan a QR code with valid data.';
}
