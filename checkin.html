<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Organizer Check-In</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: start;
      background: #f8f9fa; min-height: 100vh;
    }
    h2 { margin-top: 20px; }
    .container {
      width: 95%; max-width: 500px;
      background: white; padding: 20px;
      margin-top: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .hidden { display: none; }
    .field { margin: 10px 0; }
    select, button, input {
      width: 100%; padding: 10px;
      margin-top: 5px;
      border-radius: 5px; border: 1px solid #ccc;
    }
    .alert {
      margin-top: 15px;
      padding: 10px;
      border-radius: 5px;
      font-weight: bold;
    }
    .alert-success { background: #d4edda; color: #155724; }
    .alert-error { background: #f8d7da; color: #721c24; }
    #authModal {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.6);
      display: flex; align-items: center; justify-content: center;
    }
    #authModal .modal-box {
      background: white; padding: 20px;
      border-radius: 8px; text-align: center;
    }
  </style>
</head>
<body>

<div id="authModal">
  <div class="modal-box">
    <h3>Enter Organizer Code</h3>
    <input id="authCodeInput" type="password" placeholder="Enter code">
    <button onclick="authenticate()">Submit</button>
    <div id="authError" class="alert alert-error hidden">Incorrect Code</div>
  </div>
</div>

<h2>Organizer Check-In</h2>
<div class="container hidden" id="mainApp">
  <div id="qr-reader" style="width:100%;"></div>
  <div class="field" id="resultSection" style="display:none;">
    <h4>Scanned Data</h4>
    <div id="attendeeInfo"></div>
    <label for="countSelect">Number of people checking in:</label>
    <select id="countSelect"></select>
    <button onclick="submitCheckin()">✅ Confirm Check-In</button>
    <div id="responseMsg" class="alert hidden"></div>
  </div>
</div>

<script>
  const correctCode = "nss2024"; // Change to your real auth code
  let attendeeData = null;

  function authenticate() {
    const input = document.getElementById("authCodeInput").value;
    if (input === correctCode) {
      document.getElementById("authModal").style.display = "none";
      document.getElementById("mainApp").classList.remove("hidden");
      startScanner();
    } else {
      document.getElementById("authError").classList.remove("hidden");
    }
  }

  function startScanner() {
    const qrScanner = new Html5Qrcode("qr-reader");
    qrScanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      decodedText => {
        try {
          qrScanner.stop();
          const decoded = JSON.parse(atob(decodeURIComponent(decodedText.split('data=')[1])));
          attendeeData = decoded;
          renderAttendee(decoded);
        } catch (e) {
          showError("❌ Invalid QR format.");
        }
      },
      err => { /* Ignore scan errors */ }
    );
  }

  function renderAttendee(data) {
    const info = data.data || {};
    const event = info.event || "Unknown Event";
    const name = info.name;
    const email = info.email;
    const date = info.date;
    const maxAllowed = info.max_scan_count || 1;
    const alreadyScanned = info.current_scan_count || 0;
    const remaining = maxAllowed - alreadyScanned;

    if (remaining <= 0) {
      showError("❌ This QR code has already been fully used.");
      return;
    }

    document.getElementById("attendeeInfo").innerHTML = `
      <p><strong>Name:</strong> ${name}</p>
      <p><strong>Email:</strong> ${email}</p>
      <p><strong>Event:</strong> ${event}</p>
      <p><strong>Remaining Entries:</strong> ${remaining}</p>
    `;

    const select = document.getElementById("countSelect");
    select.innerHTML = "";
    for (let i = 1; i <= remaining; i++) {
      const opt = document.createElement("option");
      opt.value = i;
      opt.text = i;
      select.appendChild(opt);
    }

    document.getElementById("resultSection").style.display = "block";
  }

  function showError(msg) {
    const r = document.getElementById("responseMsg");
    r.className = "alert alert-error";
    r.innerText = msg;
    r.classList.remove("hidden");
  }

  function showSuccess(msg) {
    const r = document.getElementById("responseMsg");
    r.className = "alert alert-success";
    r.innerText = msg;
    r.classList.remove("hidden");
  }

  function submitCheckin() {
    const count = parseInt(document.getElementById("countSelect").value);
    const name = attendeeData.data.name;

    // Simulate update
    setTimeout(() => {
      showSuccess(`✅ Check-in successful for ${count} person(s) under ${name}.`);
    }, 500);

    // In real app: send a POST request to your backend with updated scan count
  }
</script>
</body>
</html>
